<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    
    <!-- Primary Meta Tags -->
    <title>Carbon Sink Tracker - Gujarat LULC Analysis</title>
    <meta name="title" content="Carbon Sink Tracker - Gujarat LULC Analysis" />
    <meta name="description" content="Interactive Land Use Land Cover mapping and carbon emissions analytics for Gujarat. Visualize forest, wetland, and cropland changes over time with advanced geospatial tools." />
    <meta name="keywords" content="carbon sink, LULC, land use, land cover, Gujarat, mapping, analytics, forest cover, wetland, carbon emissions, geospatial, GIS" />
    <meta name="author" content="Carbon Sink Tracker" />
    <meta name="robots" content="index, follow" />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Carbon Sink Tracker - Gujarat LULC Analysis" />
    <meta property="og:description" content="Interactive Land Use Land Cover mapping and carbon emissions analytics for Gujarat" />
    <meta property="og:site_name" content="Carbon Sink Tracker" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Carbon Sink Tracker - Gujarat LULC Analysis" />
    <meta name="twitter:description" content="Interactive Land Use Land Cover mapping and carbon emissions analytics for Gujarat" />
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />
    
    <!-- Performance -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://unpkg.com" />
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" integrity="sha384-CfAJOXg9MYvC8MZ2J8UwAUy/+sAIEljRLqTlqzjvZyNpvqJwUc1nDcGVkCXcCTuL" crossorigin="anonymous" />
    
    <!-- Fonts with display=swap for better performance -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet" />
    
    <!-- Chart.js - deferred for better initial page load -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" as="script" />
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Dynamic base path for static files -->
    <script>
      // Environment detection and path configuration
      (function() {
        'use strict';
        window.isFileProtocol = window.location.protocol === 'file:';
        window.STATIC_BASE = window.isFileProtocol ? '' : '/static';
        
        // Load CSS with correct path
        const cssPath = window.isFileProtocol ? 'styles.css' : '/static/styles.css';
        const faviconPath = window.isFileProtocol ? 'logo.svg' : '/static/logo.svg';
        
        // Preload critical CSS
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = cssPath;
        link.media = 'all';
        document.head.appendChild(link);
        
        // Add favicon
        const favicon = document.createElement('link');
        favicon.rel = 'icon';
        favicon.type = 'image/svg+xml';
        favicon.href = faviconPath;
        document.head.appendChild(favicon);
        
        // Add apple touch icon for iOS
        const appleTouchIcon = document.createElement('link');
        appleTouchIcon.rel = 'apple-touch-icon';
        appleTouchIcon.href = faviconPath;
        document.head.appendChild(appleTouchIcon);
      })();
    </script>
  </head>
  <body>
    <div id="controls">
      <div id="header-container">
        <img id="logo" alt="Logo" />
        <h2>Carbon Sink Tracker</h2>
      </div>
      <div class="multiselect-wrapper">
        <label><b>District:</b></label><br />
        <button type="button" id="districtDropdownBtn">Select district(s)</button>
        <div id="districtDropdown" class="multiselect-dropdown" style="display:none;">
          <div id="district-checkboxes"></div>
        </div>
      </div>

      <label
        ><b>Filter:</b>
        <br />
        <div id="lulcFilter-wrapper">
          <select id="lulcFilter">
            <option value="all">LULC</option>
            <option value="forest">Carbon Sink</option>
          </select>
        </div>
      </label>
      <label for="yearSlider"
        ><b>Year:</b><br />
        <div id="yearSliderContainer">
          <input
            type="range"
            id="yearSlider"
            min="2012"
            max="2022"
            step="1"
            value="2022"
          />
          <span id="yearDisplay">2022</span>
        </div></label
      >
      <div class="button-row">
        <button id="submitBtn" onclick="loadLULC()" class="load-btn">
          Load
        </button>
        <button onclick="clearLULC()" class="clear-btn">
          Clear
        </button>
      </div>
      <div class="button-row">
        <button onclick="downloadLULC()" class="download-btn">
          Download
        </button>
      </div>
      
      <!-- District Animation Controls -->
      <div class="animation-controls">
        <h3>District Time Series Animation</h3>
        <label><b>Select District for Animation:</b></label>
        <select id="animationDistrictSelect" style="width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc;">
          <option value="">-- Select a district --</option>
        </select>
        <div class="animation-row">
          <button id="playBtn" onclick="toggleDistrictAnimation()" class="play-btn" disabled>郊윒잺 Play</button>
          <span id="currentAnimationYear" style="margin-left: 10px; font-weight: bold;">--</span>
        </div>
        <div class="year-slider-container">
          <input type="range" id="animationSlider" min="2012" max="2022" value="2022" step="1" disabled>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
          <span id="animationStatus">Select a district to start animation</span>
        </div>
      </div>
    </div>
    <div id="map"></div>
    
    <!-- Right Slider Panel -->
    <div id="right-panel" class="right-panel">
      <div class="panel-header">
        <h3>Analytics</h3>
        <button id="close-panel" class="close-btn">&times;</button>
      </div>
      <div class="panel-content">
        <div class="graph-toggles">
          <button class="graph-toggle active" data-graph="1">State</button>
          <button class="graph-toggle" data-graph="2">District</button>
        </div>
        
        <!-- State Section -->
        <div class="graph-section active" id="state-section">
          <!-- State Graph Toggle Buttons -->
          <div class="state-graph-toggles">
            <button class="state-graph-toggle active" data-state-graph="forest">Forest</button>
            <button class="state-graph-toggle" data-state-graph="wetland">Wetland</button>
            <button class="state-graph-toggle" data-state-graph="total">Total</button>
          </div>
          
          <div class="graphs-container">
            <div class="graph-chart-container active" id="state-forest-container">
              <div class="chart-header">
                <h4>Forest CO2e Emissions</h4>
                <button class="download-graph-btn" onclick="downloadChart('stateForestChartCanvas', 'Forest_CO2e_Emissions')" title="Download graph as PNG">游닌</button>
              </div>
              <canvas id="stateForestChartCanvas"></canvas>
            </div>
            <div class="graph-chart-container" id="state-wetland-container">
              <div class="chart-header">
                <h4>Wetland CO2e Emissions</h4>
                <button class="download-graph-btn" onclick="downloadChart('stateWetlandChartCanvas', 'Wetland_CO2e_Emissions')" title="Download graph as PNG">游닌</button>
              </div>
              <canvas id="stateWetlandChartCanvas"></canvas>
            </div>
            <div class="graph-chart-container" id="state-total-container">
              <div class="chart-header">
                <h4>Total CO2e Emissions (Forest + Wetland)</h4>
                <button class="download-graph-btn" onclick="downloadChart('stateCombinationChartCanvas', 'Total_CO2e_Emissions')" title="Download graph as PNG">游닌</button>
              </div>
              <canvas id="stateCombinationChartCanvas"></canvas>
            </div>
          </div>
        </div>
        
        <!-- District Section -->
        <div class="graph-section" id="district-section">
          <!-- District Graph Toggle Buttons -->
          <div class="district-graph-toggles">
            <button class="district-graph-toggle active" data-district-graph="forest">Forest</button>
            <button class="district-graph-toggle" data-district-graph="wetland">Wetland</button>
            <button class="district-graph-toggle" data-district-graph="total">Total</button>
          </div>
          
          <div class="graphs-container">
            <div class="graph-chart-container active" id="district-forest-container">
              <div class="chart-header">
                <h4>Forest CO2e Emissions by District</h4>
                <button class="download-graph-btn" onclick="downloadChart('districtForestChartCanvas', 'Forest_CO2e_Emissions_by_District')" title="Download graph as PNG">游닌</button>
              </div>
              <canvas id="districtForestChartCanvas"></canvas>
            </div>
            <div class="graph-chart-container" id="district-wetland-container">
              <div class="chart-header">
                <h4>Wetland CO2e Emissions by District</h4>
                <button class="download-graph-btn" onclick="downloadChart('districtWetlandChartCanvas', 'Wetland_CO2e_Emissions_by_District')" title="Download graph as PNG">游닌</button>
              </div>
              <canvas id="districtWetlandChartCanvas"></canvas>
            </div>
            <div class="graph-chart-container" id="district-total-container">
              <div class="chart-header">
                <h4>Total CO2e Emissions by District (Forest + Wetland)</h4>
                <button class="download-graph-btn" onclick="downloadChart('districtCombinationChartCanvas', 'Total_CO2e_Emissions_by_District')" title="Download graph as PNG">游닌</button>
              </div>
              <canvas id="districtCombinationChartCanvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Chart Icon Button -->
    <button id="chart-icon" class="chart-icon">游늵</button>
    
    <!-- Leaflet JS - with integrity checks and deferred loading -->
    <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
    <script defer src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js" crossorigin="anonymous"></script>
    <!-- Configure API base URL -->
    <script>
      // API endpoint configuration with environment detection
      (function() {
        'use strict';
        const isLocal = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1' ||
                       window.isFileProtocol;
        
        // Set API base URL
        window.API_BASE = isLocal 
          ? 'http://localhost:8000' 
          : 'https://carbon-sink-tracker-1.onrender.com';
        
        // Log environment (remove in production if not needed)
        if (isLocal) {
          console.info('游댢 Running in development mode');
        } else {
          console.info('游 Running in production mode');
        }
      })();
    </script>
    <script>
      // Initialize application with proper loading sequence
      (function() {
        'use strict';
        
        // Set logo path when DOM is ready
        window.addEventListener('DOMContentLoaded', function() {
          const logoImg = document.getElementById('logo');
          if (logoImg) {
            logoImg.src = window.isFileProtocol ? 'logo.svg' : '/static/logo.svg';
            logoImg.onerror = function() {
              console.warn('Logo failed to load');
              this.style.display = 'none';
            };
          }
        });
        
        // Load main application script
        function loadMainScript() {
          const script = document.createElement('script');
          script.src = window.isFileProtocol ? 'main.js' : '/static/main.js';
          script.defer = true;
          script.onerror = function() {
            console.error('Failed to load main application script');
            document.body.innerHTML += '<div style="padding: 20px; color: red; text-align: center;">Failed to load application. Please refresh the page.</div>';
          };
          document.body.appendChild(script);
        }
        
        // Load after other deferred scripts are ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', loadMainScript);
        } else {
          loadMainScript();
        }
      })();
    </script>
    
    <!-- Service Worker for offline support (optional, uncomment if needed) -->
    <!-- <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js').then(function(registration) {
            console.log('ServiceWorker registration successful');
          }, function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script> -->
  </body>
</html>
